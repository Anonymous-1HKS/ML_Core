<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SupML v15.2 - Final Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* === CORE VARIABLES === */
        :root {
            --primary: #0A84FF; --primary-glow: rgba(10, 132, 255, 0.5);
            --accent: #BF5AF2; --success: #30D158; --danger: #FF453A; --warning: #FF9F0A;
            --bg-body: #d4d4d8; --text-main: #000; --text-muted: #666;
            --glass-bg: rgba(255, 255, 255, 0.55);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-highlight: rgba(255, 255, 255, 0.8);
            --glass-blur: 40px; --glass-shadow: 0 20px 40px rgba(0,0,0,0.1);
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        [data-theme="dark"] {
            --bg-body: #000; --text-main: #FFF; --text-muted: #aaa;
            --glass-bg: rgba(30, 30, 35, 0.7); --glass-border: rgba(255, 255, 255, 0.15); --glass-highlight: rgba(255, 255, 255, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { height: 100vh; overflow: hidden; background: var(--bg-body); color: var(--text-main); transition: 0.5s; font-size: 16px; }

        /* FLUID BG */
        .fluid-bg { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 10% 20%, var(--danger), transparent 40%), radial-gradient(circle at 90% 80%, var(--primary), transparent 40%), radial-gradient(circle at 50% 50%, var(--accent), transparent 50%); filter: blur(80px); opacity: 0.6; animation: flow 20s infinite alternate; transition: 0.5s; }
        @keyframes flow { 0% { transform: scale(1); } 100% { transform: scale(1.15); } }

        /* BUTTONS */
        .btn-liquid { border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-main); transition: all 0.3s var(--ease-spring); background: linear-gradient(135deg, var(--glass-highlight) 0%, rgba(255,255,255,0.1) 100%); backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--glass-border); box-shadow: inset 0 2px 4px var(--glass-highlight), 0 8px 20px rgba(0,0,0,0.1); }
        .btn-liquid:hover { transform: translateY(-4px) scale(1.02); box-shadow: inset 0 2px 6px #fff, 0 15px 30px rgba(0,0,0,0.15); }
        .btn-liquid:active { transform: scale(0.95); }
        .btn-liquid.active { background: var(--primary); color: white; border-color: rgba(255,255,255,0.3); box-shadow: inset 0 2px 6px rgba(255,255,255,0.4), 0 10px 25px var(--primary-glow); }
        .mic-listening { animation: pulse-red 1.5s infinite; background: var(--danger) !important; color: white !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 69, 58, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 69, 58, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 69, 58, 0); } }
        .shape-sq { width: 54px; height: 54px; border-radius: 18px; font-size: 1.3rem; }
        .shape-cir { width: 46px; height: 46px; border-radius: 50%; }
        .shape-pill { padding: 10px 24px; border-radius: 40px; font-weight: 600; font-size: 0.95rem; }

        /* WELCOME */
        #welcome-screen { position: fixed; inset: 0; z-index: 10000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; transition: opacity 0.8s, transform 0.8s; opacity: 1; pointer-events: all; }
        #welcome-screen.hidden-screen { opacity: 0; pointer-events: none; transform: scale(1.1); filter: blur(10px); }
        #star-canvas { position: absolute; inset: 0; width: 100%; height: 100%; }
        .welcome-content { position: relative; z-index: 10001; transition: 0.5s; }
        .hero-title { font-size: 5rem; font-weight: 900; letter-spacing: -2px; margin: 0; background: linear-gradient(135deg, #fff 0%, #aaa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 30px rgba(255,255,255,0.3); }
        .hero-subtitle { font-size: 1.2rem; color: #888; margin-top: 10px; margin-bottom: 40px; letter-spacing: 1px; }
        .btn-enter { background: white; color: black; border: none; padding: 15px 40px; font-size: 1rem; font-weight: 700; border-radius: 50px; cursor: pointer; transition: 0.3s; box-shadow: 0 0 20px rgba(255,255,255,0.2); text-transform: uppercase; }
        .btn-enter:hover { transform: scale(1.1); box-shadow: 0 0 40px rgba(255,255,255,0.6); }

        /* LAYOUT */
        .app-container { display: flex; height: 100vh; padding: 20px; gap: 25px; padding-top: 60px; }
        .dock { width: 90px; display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 25px 0; border-radius: 40px; z-index: 50; background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); }
        .main-view { flex: 1; position: relative; border-radius: 40px; overflow: hidden; background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); }
        .page { position: absolute; inset: 0; padding: 35px; display: none; flex-direction: column; animation: zoomIn 0.4s var(--ease-spring); overflow-y: auto; scroll-behavior: smooth; }
        .page.active { display: flex; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .status-bar { position: absolute; top: 0; left: 0; width: 100%; height: 45px; z-index: 100; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); font-size: 0.9rem; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.1); }

        /* CHAT STYLES */
        .chat-layout { display: flex; height: 100%; gap: 25px; }
        .chat-sidebar { width: 260px; border-right: 1px solid rgba(255,255,255,0.15); padding-right: 15px; display: flex; flex-direction: column; }
        .chat-main { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chat-window { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .msg { display: flex; margin-bottom: 20px; width: 100%; transition: all 0.5s ease; position: relative; }
        .msg.user { justify-content: flex-end; }
        .bubble { padding: 14px 22px; border-radius: 22px; max-width: 85%; background: rgba(255,255,255,0.6); font-size: 1rem; line-height: 1.6; text-align: left; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.3s; }
        .msg.user .bubble { background: var(--primary); color: white; text-align: right; box-shadow: 0 5px 20px var(--primary-glow); }
        .input-area { background: rgba(255,255,255,0.3); backdrop-filter: blur(30px); padding: 10px; border-radius: 50px; display: flex; gap: 12px; align-items: center; margin-top: 15px; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        textarea { flex: 1; background: transparent; border: none; height: 28px; resize: none; color: var(--text-main); font-size: 1.05rem; padding-left: 15px; }
        .typing span { width: 8px; height: 8px; background: var(--text-main); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; margin: 0 2px; }
        .typing span:nth-child(1){animation-delay:-0.32s} .typing span:nth-child(2){animation-delay:-0.16s} @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

        /* NEW: CHAT ACTIONS & HISTORY */
        .msg-actions {
            position: absolute; top: 50%; transform: translateY(-50%);
            opacity: 0; pointer-events: none; transition: 0.2s;
            display: flex; gap: 5px; z-index: 10;
        }
        .msg:hover .msg-actions { opacity: 1; pointer-events: all; }
        .msg.user .msg-actions { left: 0; transform: translate(-110%, -50%); } /* B√™n tr√°i tin nh·∫Øn user */
        .msg.ai .msg-actions { right: 0; transform: translate(110%, -50%); } /* B√™n ph·∫£i tin nh·∫Øn AI */

        .btn-action {
            width: 32px; height: 32px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.9); color: #666; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: 0.2s;
        }
        .btn-action:hover { transform: scale(1.15); color: var(--danger); background: white; }

        .history-list { overflow-y: auto; flex: 1; padding-right: 5px; }
        .history-item {
            padding: 12px 15px; border-radius: 15px; margin-bottom: 8px; cursor: pointer;
            font-size: 0.9rem; background: rgba(255,255,255,0.1); color: var(--text-muted);
            transition:0.2s; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
            border: 1px solid transparent; display: flex; align-items: center; justify-content: space-between;
        }
        .history-item:hover { background: rgba(255,255,255,0.3); transform: translateX(5px); color: var(--text-main); border-color: var(--glass-border); }
        .history-item.active { background: var(--primary); color: white; border-color: rgba(255,255,255,0.3); box-shadow: 0 4px 10px var(--primary-glow); }
        .history-item .delete-chat-btn { margin-left: 10px; opacity: 0; transition: 0.2s; font-size: 0.8rem; padding: 4px; }
        .history-item:hover .delete-chat-btn { opacity: 1; }
        .history-item .delete-chat-btn:hover { color: var(--danger); background: rgba(255,255,255,0.2); border-radius: 50%; }

        .gen-image { max-width: 100%; border-radius: 16px; margin-top: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }
        .chart-container { position: relative; width: 100%; height: 300px; background: rgba(255,255,255,0.5); padding: 15px; border-radius: 16px; margin-top: 10px; border: 1px solid rgba(0,0,0,0.1); }

        /* CODE & OTHER STYLES */
        .code-container { display: flex; flex: 1; gap: 20px; height: 100%; overflow: hidden; margin-top: 15px; }
        .editor-pane { flex: 1; display: flex; flex-direction: column; gap: 15px; } .output-pane { flex: 1; background: #181818; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); box-shadow: inset 0 0 30px rgba(0,0,0,0.5); }
        .code-toolbar { display: flex; gap: 15px; align-items: center; padding: 12px; flex-wrap: wrap; background: rgba(255,255,255,0.15); border-radius: 24px; border: 1px solid rgba(255,255,255,0.2); }
        .code-toolbar .btn-liquid { height: 48px; padding: 0 25px; font-size: 1rem; font-weight: 600; border-radius: 16px; flex-grow: 1; min-width: 120px; }
        .code-toolbar .btn-liquid.active { flex-grow: 2; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 10px 30px var(--primary-glow); }
        .lang-select { background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.4); padding: 0 20px; height: 48px; border-radius: 16px; font-weight: 700; color: var(--text-main); cursor: pointer; backdrop-filter: blur(10px); outline: none; min-width: 160px; font-size: 1rem; }
        .editor-wrapper { flex: 1; background: #1e1e1e; border-radius: 24px; overflow: hidden; display: flex; border: 1px solid rgba(255,255,255,0.1); }
        .line-numbers { width: 50px; background: #252526; color: #777; text-align: right; padding: 20px 10px; border-right: 1px solid #333; font-family: 'JetBrains Mono', monospace; font-size: 14px; line-height: 1.6; user-select: none; }
        .code-area { flex: 1; height: 100%; padding: 20px; background: transparent; border: none; resize: none; color: #d4d4d4; font-family: 'JetBrains Mono', monospace; font-size: 14px; line-height: 1.6; white-space: pre; overflow: auto; }
        .tab-bar { display: flex; background: #252526; padding: 5px; gap: 5px; }
        .tab { padding: 8px 20px; color: #888; cursor: pointer; font-size: 0.9rem; transition: 0.2s; font-weight: 500; border-radius: 8px; }
        .tab.active { background: #333; color: white; }
        .terminal { flex: 1; background: #0c0c0c; color: #30D158; padding: 20px; font-family: 'VT323', monospace; font-size: 1.1rem; overflow: auto; white-space: pre-wrap; display: none; }
        .iframe-preview { flex: 1; background: white; border: none; display: block; }
        .ai-command-box { background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.5); border-radius: 24px; padding: 8px; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: 0.3s; }
        .ai-command-box:focus-within { box-shadow: 0 15px 40px rgba(10, 132, 255, 0.15); border-color: var(--primary-glow); background: rgba(255,255,255,0.6); }
        .ai-textarea { flex: 1; background: transparent; border: none; padding: 12px 15px; font-size: 0.95rem; color: var(--text-main); resize: none; height: 48px; line-height: 24px; font-family: 'Inter', sans-serif; }
        .btn-magic { width: 48px; height: 48px; border-radius: 18px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px var(--primary-glow); transition: 0.3s var(--ease-spring); }

        .widget-card { background: linear-gradient(145deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.4); border-radius: 30px; padding: 25px; display: flex; flex-direction: column; justify-content: space-between; transition: 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .widget-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
        .big-text { font-size: 3.8rem; font-weight: 800; line-height: 1; }
        .sub-text { opacity: 0.7; font-size: 1rem; }
        .settings-container { overflow-y: auto; padding-right: 10px; padding-bottom: 50px; }
        .settings-section { background: rgba(255,255,255,0.1); border-radius: 28px; padding: 30px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(30px); box-shadow: 0 10px 30px rgba(0,0,0,0.02); }
        .settings-header { font-size: 1.2rem; font-weight: 800; margin-bottom: 25px; color: var(--primary); display: flex; align-items: center; gap: 12px; letter-spacing: 0.5px; text-transform: uppercase; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.05rem; font-weight: 500; border-radius: 16px; transition: 0.2s; }
        .setting-row:last-child { border-bottom: none; }
        .setting-row:hover { background: rgba(255,255,255,0.1); padding-left: 20px; }
        .profile-card { background: linear-gradient(135deg, var(--glass-highlight) 0%, rgba(255,255,255,0.05) 100%); border: 1px solid var(--glass-border); border-radius: 30px; padding: 25px; display: flex; align-items: center; gap: 20px; margin-bottom: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--accent)); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; font-weight: 800; box-shadow: 0 10px 20px var(--primary-glow); border: 4px solid rgba(255,255,255,0.3); }
        .badge { background: var(--warning); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; box-shadow: 0 4px 10px rgba(255, 159, 10, 0.4); }
        .progress-bar-container { width: 100%; background: rgba(0,0,0,0.1); height: 10px; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 25%; border-radius: 10px; }
        .color-picker-container { display: flex; gap: 10px; }
        .color-btn { width: 32px; height: 32px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: 0.3s var(--ease-spring); background: var(--c); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .color-btn.active { border-color: white; transform: scale(1.2); box-shadow: 0 8px 20px var(--c); }
        .switch { position: relative; display: inline-block; width: 52px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.2); transition: .4s; border-radius: 34px; backdrop-filter: blur(5px); }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(22px); }
        input[type=range] { width: 150px; accent-color: var(--primary); cursor: pointer; }
        .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.75); backdrop-filter: blur(20px); color: white; padding: 14px 30px; border-radius: 40px; opacity: 0; transition: 0.4s var(--ease-spring); pointer-events: none; z-index: 2000; font-weight: 600; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 10px; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
        #imagePreview { position: absolute; bottom: 80px; left: 10px; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 16px; display: none; box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        #loginPage { position: fixed; inset: 0; z-index: 999; background: rgba(0,0,0,0.1); backdrop-filter: blur(30px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.5s; transform: scale(0.9); }
        #loginPage.show { opacity: 1; pointer-events: all; transform: scale(1); }
        .login-card { width: 400px; padding: 50px; border-radius: 40px; background: rgba(255,255,255,0.65); text-align: center; border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 30px 80px rgba(0,0,0,0.15); }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 18px; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.4); outline: none; font-size: 1rem; transition: 0.3s; }
        .hidden { display: none !important; }
        .ai-loading { position: absolute; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; color: white; border-radius: 24px; }
    </style>
</head>
<body>
    <div id="welcome-screen">
        <canvas id="star-canvas"></canvas>
        <div class="welcome-content">
            <h1 class="hero-title">SupML</h1>
            <p class="hero-subtitle">NEXT-GEN AI OS</p>
            <button class="btn-enter" onclick="enterSystem()">Kh√°m ph√° ngay</button>
        </div>
    </div>

    <div class="fluid-bg"></div>
    <div id="toast" class="toast"><i class="fa-solid fa-check-circle" style="color: var(--success);"></i> <span>H·ªá th·ªëng s·∫µn s√†ng</span></div>

    <div class="status-bar">
        <div style="display: flex; gap: 20px;">
            <span id="clock" style="font-weight: 800;">--:--</span>
            <span id="date">--/--</span>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <i class="fa-solid fa-wifi"></i>
            <span id="systemStatus" style="color: var(--success); font-weight: 700;">Online</span>
            <i class="fa-solid fa-battery-full"></i>
        </div>
    </div>

    <div id="loginPage">
        <div class="login-card" id="tiltCard">
            <div style="font-size: 4rem; margin-bottom: 10px;">üßä</div>
            <h1 style="margin-bottom: 10px; font-weight: 900; font-size: 2rem;">SupML Gel OS</h1>
            <p style="margin-bottom: 30px; color: var(--text-muted); font-weight: 500;">VisionOS Design Language</p>
            <input type="text" id="email" class="login-input" placeholder="Email" value="admin@supml.com">
            <input type="password" id="password" class="login-input" placeholder="M·∫≠t kh·∫©u" value="123456">
            <button class="btn-liquid shape-pill" style="width: 100%; margin-top: 25px; background: var(--primary); color: white; font-size: 1.1rem; padding: 15px;" onclick="login()">M·ªü Kh√≥a</button>
        </div>
    </div>

    <div id="app" class="app-container hidden">
        <div class="dock">
            <button id="btn-dashboard" class="btn-liquid shape-sq active" onclick="nav('dashboard')"><i class="fa-solid fa-chart-pie"></i></button>
            <button id="btn-chat" class="btn-liquid shape-sq" onclick="nav('chat')"><i class="fa-solid fa-comments"></i></button>
            <button id="btn-code" class="btn-liquid shape-sq" onclick="nav('code')"><i class="fa-solid fa-code"></i></button>
            <button id="btn-settings" class="btn-liquid shape-sq" onclick="nav('settings')"><i class="fa-solid fa-sliders"></i></button>
            <div style="flex: 1;"></div>
            <button class="btn-liquid shape-cir" onclick="lockScreen()" title="Kh√≥a m√†n h√¨nh"><i class="fa-solid fa-lock"></i></button>
            <button class="btn-liquid shape-cir" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
        </div>

        <div class="main-view">
            <div id="page-dashboard" class="page active">
                <h1 style="font-size: 3rem; margin-bottom: 25px; font-weight: 800;" id="greeting">Xin ch√†o</h1>
                <div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr; grid-template-rows: 180px 180px; gap: 25px;">
                    <div class="widget-card" style="grid-row: span 2; background: linear-gradient(135deg, #4facfecc 0%, #00f2fecc 100%); color: white; border: none;">
                        <div style="display: flex; justify-content: space-between;">
                            <i class="fa-solid fa-cloud-sun" style="font-size: 5rem; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));"></i>
                            <div style="text-align: right;">
                                <h2 style="margin: 0; font-size: 1.5rem;">TP.HCM</h2>
                                <span id="weatherDesc" style="font-weight: 500;">ƒêang t·∫£i...</span>
                            </div>
                        </div>
                        <div>
                            <div class="big-text" id="weatherTemp" style="text-shadow: 0 5px 20px rgba(0,0,0,0.2);">--¬∞</div>
                            <div class="sub-text" style="color: rgba(255,255,255,0.9);">C·∫£m gi√°c nh∆∞: <span id="feelsLike">--</span>¬∞</div>
                        </div>
                    </div>
                    <div class="widget-card">
                        <i class="fa-regular fa-clock" style="font-size: 1.8rem; color: var(--primary);"></i>
                        <div class="big-text" id="dashClock" style="font-size: 3rem;">--:--</div>
                        <div class="sub-text" id="dashDate" style="font-weight: 600;">--/--/----</div>
                    </div>
                    <div class="widget-card" style="grid-column: span 2;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 800; color: var(--danger); display: flex; align-items: center; gap: 10px;"><i class="fa-solid fa-fire"></i> TIN N√ìNG C√îNG NGH·ªÜ</span>
                            <span style="font-size: 0.8rem; background: rgba(255, 69, 58, 0.1); color: var(--danger); padding: 4px 10px; border-radius: 12px; font-weight: 700;">M·ªöI NH·∫§T</span>
                        </div>
                        <div id="newsTicker" style="font-size: 1.2rem; font-weight: 600; margin-top: 15px; line-height: 1.4;">ƒêang t·∫£i tin t·ª©c...</div>
                    </div>
                    <div class="widget-card" style="background: var(--glass-bg);">
                        <i class="fa-solid fa-microchip" style="font-size: 1.8rem; color: var(--accent);"></i>
                        <div style="font-weight: 800; font-size: 1.4rem;">CPU: <span style="color: var(--accent)">12%</span></div>
                        <div class="sub-text" style="font-weight: 600;">RAM: 4.2GB / 16GB</div>
                    </div>
                </div>
            </div>

            <div id="page-chat" class="page">
                <div class="chat-layout">
                    <div class="chat-sidebar">
                        <button class="btn-liquid shape-pill" style="width: 100%; margin-bottom: 20px; font-size: 1rem;" onclick="startNewChat()"><i class="fa-solid fa-plus" style="margin-right: 8px;"></i> Chat M·ªõi</button>
                        <div style="font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; opacity: 0.6;">L·ªäCH S·ª¨</div>
                        <div class="history-list" id="historyList"></div>
                        <button class="btn-liquid shape-sq" style="margin-top: auto; color: var(--danger); background: rgba(255, 69, 58, 0.1); width: 100%;" onclick="clearHistory()"><i class="fa-solid fa-trash" style="margin-right: 10px;"></i> X√≥a H·∫øt</button>
                    </div>
                    <div class="chat-main">
                        <div class="chat-window" id="chatWindow">
                            <div class="msg ai"><div class="bubble">SupML AI ƒë√£ s·∫µn s√†ng h·ªó tr·ª£.</div></div>
                        </div>
                        <div id="imagePreview"><img id="previewImg" src="" style="height: 60px; border-radius: 8px;"><button onclick="clearImage()" style="position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-weight: bold;">√ó</button></div>
                        <div class="input-area">
                            <label class="btn-liquid shape-cir"><i class="fa-solid fa-paperclip"></i><input type="file" hidden id="fileInput" onchange="handleFile(this)"></label>

                            <button id="btn-mic" class="btn-liquid shape-cir" onclick="toggleVoice()"><i class="fa-solid fa-microphone"></i></button>

                            <textarea id="msgInput" placeholder="Nh·∫≠p tin nh·∫Øn ho·∫∑c n√≥i..." onkeydown="checkEnter(event)"></textarea>
                            <div class="btn-liquid shape-cir active" style="width: 50px; height: 50px; cursor: pointer;" onclick="sendMessage(null)"><i class="fa-solid fa-arrow-up"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-code" class="page">
                <div class="code-toolbar">
                    <select id="langSelect" class="lang-select" onchange="changeLang()">
                        <option value="web">üåê Web (HTML)</option>
                        <option value="python">üêç Python</option>
                        <option value="cpp">‚öôÔ∏è C++</option>
                        <option value="java">‚òï Java</option>
                    </select>
                    <button class="btn-liquid" onclick="aiAction('fix')" style="color: var(--danger); background: rgba(255, 69, 58, 0.15);"><i class="fa-solid fa-bug" style="margin-right: 8px;"></i> S·ª≠a L·ªói</button>
                    <button class="btn-liquid" onclick="aiAction('explain')" style="color: var(--primary); background: rgba(10, 132, 255, 0.15);"><i class="fa-solid fa-wand-magic-sparkles" style="margin-right: 8px;"></i> Gi·∫£i th√≠ch</button>
                    <button class="btn-liquid active" onclick="runCode()"><i class="fa-solid fa-play" style="margin-right: 8px;"></i> CH·∫†Y</button>
                </div>
                <div class="code-container">
                    <div class="editor-pane">
                        <div class="editor-wrapper">
                            <div id="aiLoading" class="ai-loading"><i class="fa-solid fa-spinner fa-spin" style="font-size: 2.5rem; color: var(--primary);"></i><br><span style="margin-top: 15px; font-weight: 600;">AI ƒëang l·∫≠p tr√¨nh...</span></div>
                            <div class="line-numbers" id="lineNumbers">1</div>
                            <textarea id="codeEditor" class="code-area" spellcheck="false" oninput="updateLineNumbers()" onscroll="syncScroll()"></textarea>
                        </div>
                        <div class="ai-command-box">
                            <i class="fa-solid fa-wand-magic-sparkles" style="color: var(--accent); margin-left: 10px; font-size: 1.2rem;"></i>
                            <textarea id="codePrompt" class="ai-textarea" placeholder="Nh·∫≠p y√™u c·∫ßu AI t·∫°i ƒë√¢y... (V√≠ d·ª•: T·∫°o m·ªôt trang web gi·ªõi thi·ªáu b·∫£n th√¢n m√†u xanh d∆∞∆°ng)"></textarea>
                            <button class="btn-magic" onclick="aiAction('suggest')"><i class="fa-solid fa-stars"></i></button>
                        </div>
                    </div>
                    <div class="output-pane">
                        <div class="tab-bar">
                            <div class="tab active" id="tabPreview" onclick="switchTab('preview')"><i class="fa-solid fa-globe"></i> Live Preview</div>
                            <div class="tab" id="tabTerminal" onclick="switchTab('terminal')"><i class="fa-solid fa-terminal"></i> Terminal (>_)</div>
                        </div>
                        <iframe id="previewFrame" class="iframe-preview"></iframe>
                        <div id="terminalOutput" class="terminal">Welcome to SupML Terminal v1.5 [Gel Edition]<br>Ready to execute code...</div>
                    </div>
                </div>
            </div>

            <div id="page-settings" class="page">
                <div class="settings-container">
                    <h1 style="margin-bottom: 25px; font-size: 2.5rem; font-weight: 800;">C√†i ƒë·∫∑t</h1>
                    <div class="profile-card">
                        <div class="profile-avatar">AD</div>
                        <div style="flex: 1;">
                            <div style="font-size: 1.5rem; font-weight: 800;">Admin User <span class="badge">PRO</span></div>
                            <div style="opacity: 0.6;">admin@supml.com</div>
                            <div style="margin-top: 10px; font-size: 0.9rem; font-weight: 600; color: var(--text-muted);">
                                Cloud Storage
                                <div class="progress-bar-container"><div class="progress-bar"></div></div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 5px;"><span>45GB used</span><span>100GB total</span></div>
                            </div>
                        </div>
                        <button class="btn-liquid shape-cir" onclick="showToast('Ch·ªânh s·ª≠a h·ªì s∆°')"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <div class="settings-section">
                        <div class="settings-header"><i class="fa-solid fa-palette"></i> Giao di·ªán & Hi·ªÉn th·ªã</div>
                        <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 15px;">
                            <span>M√†u ch·ªß ƒë·∫°o (Accent Color)</span>
                            <div class="color-picker-container">
                                <button class="color-btn active" style="--c:#0A84FF" onclick="setAccent(this, '#0A84FF')"></button>
                                <button class="color-btn" style="--c:#BF5AF2" onclick="setAccent(this, '#BF5AF2')"></button>
                                <button class="color-btn" style="--c:#FF3B30" onclick="setAccent(this, '#FF3B30')"></button>
                                <button class="color-btn" style="--c:#30D158" onclick="setAccent(this, '#30D158')"></button>
                                <button class="color-btn" style="--c:#FF9F0A" onclick="setAccent(this, '#FF9F0A')"></button>
                            </div>
                        </div>
                        <div class="setting-row"><span>Ch·∫ø ƒë·ªô T·ªëi (Dark Mode)</span><label class="switch"><input type="checkbox" onchange="toggleTheme()"><span class="slider"></span></label></div>
                        <div class="setting-row"><span>H√¨nh n·ªÅn ƒë·ªông (Fluid BG)</span><label class="switch"><input type="checkbox" checked onchange="toggleBg(this)"><span class="slider"></span></label></div>
                        <div class="setting-row"><span>ƒê·ªô m·ªù k√≠nh (Blur Intensity)</span><input type="range" min="10" max="60" value="40" oninput="changeBlur(this)"></div>
                        <div class="setting-row"><span>C·ª° ch·ªØ h·ªá th·ªëng</span><input type="range" min="14" max="20" value="16" oninput="changeFontSize(this)"></div>
                    </div>
                    <div class="settings-section">
                        <div class="settings-header"><i class="fa-solid fa-shield-halved"></i> H·ªá th·ªëng & B·∫£o m·∫≠t</div>
                        <div class="setting-row"><span>Th√¥ng b√°o ƒë·∫©y</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
                        <div class="setting-row"><span>√Çm thanh h·ªá th·ªëng</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
                        <div class="setting-row"><span>X√°c th·ª±c 2 l·ªõp (2FA)</span><label class="switch"><input type="checkbox"><span class="slider"></span></label></div>
                        <div class="setting-row" onclick="checkUpdate()" style="cursor: pointer;"><span>Ki·ªÉm tra c·∫≠p nh·∫≠t</span><span id="updateStatus" style="color: var(--text-muted); font-size: 0.9rem;">v13.0 (M·ªõi nh·∫•t)</span></div>
                        <div class="setting-row" onclick="clearCache()" style="cursor: pointer; color: var(--danger);"><span>X√≥a b·ªô nh·ªõ ƒë·ªám (Cache)</span><i class="fa-solid fa-trash-can"></i></div>
                    </div>
                    <button class="btn-liquid shape-pill" style="width: 100%; color: var(--danger); background: rgba(255, 69, 58, 0.15); font-weight: 700; font-size: 1.1rem; padding: 18px;" onclick="lockScreen()"><i class="fa-solid fa-right-from-bracket" style="margin-right: 10px;"></i> ƒêƒÉng xu·∫•t an to√†n</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const API_URL = "http://127.0.0.1:5000/api";
    let selectedFile = null;

    // === QU·∫¢N L√ù SESSION (H·ªòI THO·∫†I) - M·ªöI ===
    let chatSessions = JSON.parse(localStorage.getItem('supml_sessions')) || [];
    let currentSessionId = localStorage.getItem('supml_current_session_id') || null;

    // === 1. INIT ===
    window.onload = function() {
        if(localStorage.getItem('isLoggedIn') === 'true') {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
            nav(localStorage.getItem('lastPage') || 'dashboard');
            initSystem();
            initChat();
        }
        updateLineNumbers();
    };

    // === 2. VOICE ===
    let recognition;
    let isListening = false;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false; recognition.lang = 'vi-VN'; recognition.interimResults = false;
        recognition.onstart = function() { isListening = true; document.getElementById('btn-mic').classList.add('mic-listening'); document.getElementById('msgInput').placeholder = "ƒêang l·∫Øng nghe..."; };
        recognition.onend = function() { isListening = false; document.getElementById('btn-mic').classList.remove('mic-listening'); document.getElementById('msgInput').placeholder = "Nh·∫≠p tin nh·∫Øn..."; };
        recognition.onresult = function(event) { document.getElementById('msgInput').value = event.results[0][0].transcript; setTimeout(() => sendMessage(null), 500); };
        recognition.onerror = function(event) { showToast("L·ªói Micro: " + event.error); };
    }
    function toggleVoice() { if (!recognition) { alert("D√πng Chrome ƒë·ªÉ h·ªó tr·ª£ gi·ªçng n√≥i."); return; } if (isListening) recognition.stop(); else recognition.start(); }

    // === 3. CHAT LOGIC (H·ª¢P NH·∫§T) ===

    // -- Session Management --
    function initChat() {
        if (chatSessions.length === 0) createNewSession(false);
        else if (!chatSessions.find(s => s.id === currentSessionId)) currentSessionId = chatSessions[0].id;
        renderSidebar();
        loadCurrentSession();
    }

    function createNewSession(shouldRender = true) {
        const newId = 'sess-' + Date.now();
        const newSession = { id: newId, title: 'Cu·ªôc tr√≤ chuy·ªán m·ªõi', messages: [{role: 'ai', content: 'SupML AI ƒë√£ s·∫µn s√†ng h·ªó tr·ª£ b·∫°n.'}] };
        chatSessions.unshift(newSession);
        currentSessionId = newId;
        saveData();
        if(shouldRender) { renderSidebar(); loadCurrentSession(); }
    }

    function switchSession(id) {
        currentSessionId = id;
        localStorage.setItem('supml_current_session_id', id);
        renderSidebar();
        loadCurrentSession();
    }

    function deleteSession(e, id) {
        e.stopPropagation();
        if(confirm('X√≥a h·ªôi tho·∫°i n√†y?')) {
            chatSessions = chatSessions.filter(s => s.id !== id);
            if (chatSessions.length === 0) createNewSession(false);
            else if (currentSessionId === id) currentSessionId = chatSessions[0].id;
            saveData(); renderSidebar(); loadCurrentSession();
        }
    }

    function saveData() {
        localStorage.setItem('supml_sessions', JSON.stringify(chatSessions));
        localStorage.setItem('supml_current_session_id', currentSessionId);
    }

    // -- Render UI --
    function renderSidebar() {
        const list = document.getElementById('historyList');
        if(!list) return;
        list.innerHTML = '';
        chatSessions.forEach(sess => {
            const activeClass = sess.id === currentSessionId ? 'active' : '';
            let icon = 'fa-message';
            if (sess.title.toLowerCase().includes('code')) icon = 'fa-code';
            else if (sess.title.toLowerCase().includes('·∫£nh') || sess.title.toLowerCase().includes('v·∫Ω')) icon = 'fa-image';

            list.innerHTML += `
                <div class="history-item ${activeClass}" onclick="switchSession('${sess.id}')">
                    <div style="display:flex; align-items:center; gap:10px; flex:1; overflow:hidden;">
                        <i class="fa-regular ${icon}"></i>
                        <span style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">${sess.title}</span>
                    </div>
                    <i class="fa-solid fa-xmark delete-chat-btn" onclick="deleteSession(event, '${sess.id}')" title="X√≥a"></i>
                </div>`;
        });
    }

    function loadCurrentSession() {
        const win = document.getElementById('chatWindow');
        win.innerHTML = '';
        const session = chatSessions.find(s => s.id === currentSessionId);
        if (!session) return;
        session.messages.forEach((msg, index) => renderMessageHTML(msg, index));
        setTimeout(() => win.scrollTop = win.scrollHeight, 100);
    }

    function renderMessageHTML(msg, index) {
        const win = document.getElementById('chatWindow');
        const isUser = msg.role === 'user';

        const actionBtn = isUser
            ? `<button class="btn-action" onclick="deleteSingleMessage(${index})" title="Thu h·ªìi"><i class="fa-solid fa-rotate-left"></i></button>`
            : `<button class="btn-action" onclick="deleteSingleMessage(${index})" title="X√≥a tin nh·∫Øn"><i class="fa-regular fa-trash-can"></i></button>`;

        let contentHtml = msg.content;

        if(msg.image) {
            contentHtml = `<img src="${msg.image}" style="max-width:200px;border-radius:12px;margin-bottom:8px;display:block;">` + contentHtml;
        }

        // Markdown Rendering
        if(msg.role === 'ai' && window.marked && !contentHtml.includes('<div class="chart-container">') && !contentHtml.includes('gen-image')) {
            contentHtml = marked.parse(contentHtml);
        }

        const html = `
            <div class="msg ${msg.role}" id="msg-${index}">
                <div class="msg-actions">${actionBtn}</div>
                <div class="bubble">${contentHtml}</div>
            </div>`;

        win.insertAdjacentHTML('beforeend', html);

        if(msg.chartData) {
            setTimeout(() => {
                const ctx = document.getElementById(msg.chartId);
                if(ctx) new Chart(ctx, msg.chartData);
            }, 200);
        }
    }

    function deleteSingleMessage(index) {
        const session = chatSessions.find(s => s.id === currentSessionId);
        if(session) {
            session.messages.splice(index, 1);
            saveData();
            loadCurrentSession();
            showToast("ƒê√£ x√≥a tin nh·∫Øn");
        }
    }

    // -- Message & AI Logic --
    function handleFile(input) { if(input.files[0]) { selectedFile = input.files[0]; const r = new FileReader(); r.onload = e => { document.getElementById('previewImg').src = e.target.result; document.getElementById('imagePreview').style.display = 'block'; }; r.readAsDataURL(selectedFile); } }
    function clearImage() { selectedFile = null; document.getElementById('imagePreview').style.display = 'none'; }
    function checkEnter(e) { if(e.key==="Enter" && !e.shiftKey) {e.preventDefault(); sendMessage(e);} }

    async function sendMessage(e) {
        if (e) { e.preventDefault(); e.stopPropagation(); }

        const txt = document.getElementById('msgInput').value.trim();
        const imgData = selectedFile ? document.getElementById('previewImg').src : null;
        const fileToSend = selectedFile;

        if(!txt && !imgData) return;

        const session = chatSessions.find(s => s.id === currentSessionId);
        if(!session) return;

        // 1. C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ session
        if(session.messages.length <= 1) {
            session.title = txt.substring(0, 30) + (txt.length>30 ? '...' : '');
            renderSidebar();
        }

        // 2. Render tin nh·∫Øn User
        const userMsg = { role: 'user', content: txt, image: imgData };
        session.messages.push(userMsg);
        saveData();
        renderMessageHTML(userMsg, session.messages.length - 1);

        document.getElementById('msgInput').value = '';
        clearImage();
        const win = document.getElementById('chatWindow');
        win.scrollTop = win.scrollHeight;

        // 3. UI ƒëang suy nghƒ©
        const thinkingID = "t-" + Date.now();
        win.insertAdjacentHTML('beforeend', `<div id="${thinkingID}" class="msg ai"><div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div></div>`);
        win.scrollTop = win.scrollHeight;

        // 4. LOGIC X·ª¨ L√ù (Command / API)

        // A. L·ªánh t·∫°o ·∫£nh
        if (txt.toLowerCase().includes("v·∫Ω") || txt.toLowerCase().includes("t·∫°o ·∫£nh")) {
            setTimeout(() => {
                document.getElementById(thinkingID).remove();
                const prompt = txt.replace(/v·∫Ω|t·∫°o ·∫£nh/gi, "").trim();
                const imgUrl = `https://pollinations.ai/p/${encodeURIComponent(prompt)}`;
                const content = `ƒê√£ t·∫°o: <b>${prompt}</b><br><img src="${imgUrl}" class="gen-image">`;

                const aiMsg = { role: 'ai', content: content };
                session.messages.push(aiMsg); saveData(); renderMessageHTML(aiMsg, session.messages.length - 1);
                win.scrollTop = win.scrollHeight;
            }, 1000);
            return;
        }

        // B. L·ªánh v·∫Ω bi·ªÉu ƒë·ªì
        if (txt.toLowerCase().includes("bi·ªÉu ƒë·ªì") || txt.toLowerCase().includes("chart")) {
            setTimeout(() => {
                document.getElementById(thinkingID).remove();
                const chartId = "chart-" + Date.now();
                const chartDataConfig = { type: 'bar', data: { labels: ['A','B','C','D'], datasets: [{ label: 'Data', data: [12,19,3,5], backgroundColor: '#0A84FF' }] }, options: { responsive: true, maintainAspectRatio: false } };
                const content = `D·ªØ li·ªáu m·∫´u:<div class="chart-container"><canvas id="${chartId}"></canvas></div>`;

                const aiMsg = { role: 'ai', content: content, chartId: chartId, chartData: chartDataConfig };
                session.messages.push(aiMsg); saveData(); renderMessageHTML(aiMsg, session.messages.length - 1);
                win.scrollTop = win.scrollHeight;
            }, 1000);
            return;
        }

        // C. G·ªçi API Backend (ho·∫∑c Fallback n·∫øu l·ªói)
        try {
            let responseText = "";
            let res;

            // Th·ª≠ g·ªçi server Python
            if(fileToSend) {
                const fd = new FormData(); fd.append('file', fileToSend); fd.append('message', txt || "M√¥ t·∫£");
                res = await fetch(`${API_URL}/chat`, {method:'POST', body:fd});
            } else {
                res = await fetch(`${API_URL}/chat`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message:txt})});
            }

            const data = await res.json();
            responseText = data.reply;
            document.getElementById(thinkingID).remove();

            const aiMsg = { role: 'ai', content: responseText };
            session.messages.push(aiMsg); saveData(); renderMessageHTML(aiMsg, session.messages.length - 1);
            win.scrollTop = win.scrollHeight;

        } catch(e) {
            // D. Fallback Mode: T·ª± tr·∫£ l·ªùi n·∫øu kh√¥ng c√≥ server
            document.getElementById(thinkingID).remove();

            // Random c√¢u tr·∫£ l·ªùi m·∫´u
            const fallbackReplies = [
                "Server ch∆∞a k·∫øt n·ªëi, nh∆∞ng t√¥i v·∫´n ·ªü ƒë√¢y!",
                "Giao di·ªán n√†y ƒë·∫πp ch·ª©? B·∫°n ƒëang th·ª≠ ch·∫ø ƒë·ªô Offline.",
                "T√¥i ƒë√£ nh·∫≠n ƒë∆∞·ª£c tin nh·∫Øn c·ªßa b·∫°n: " + txt,
                "H√£y th·ª≠ l·ªánh 'v·∫Ω con m√®o' ho·∫∑c 't·∫°o bi·ªÉu ƒë·ªì' xem sao!",
                "ƒê√¢y l√† tin nh·∫Øn t·ª± ƒë·ªông v√¨ kh√¥ng t√¨m th·∫•y Backend Python."
            ];
            const randomReply = fallbackReplies[Math.floor(Math.random() * fallbackReplies.length)];

            const aiMsg = { role: 'ai', content: `[Demo] ${randomReply}` };
            session.messages.push(aiMsg); saveData(); renderMessageHTML(aiMsg, session.messages.length - 1);
            win.scrollTop = win.scrollHeight;

            showToast("ƒêang ch·∫°y ch·∫ø ƒë·ªô Demo (Offline)");
        }
    }

    function startNewChat() { createNewSession(true); }
    function clearHistory() { if(confirm("X√≥a T·∫§T C·∫¢ d·ªØ li·ªáu chat?")){ localStorage.removeItem('supml_sessions'); chatSessions=[]; createNewSession(); showToast("ƒê√£ d·ªçn s·∫°ch."); } }

    // === SYSTEM UTILS (CORE) ===
    function nav(page) { localStorage.setItem('lastPage', page); document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById('page-'+page).classList.add('active'); document.querySelectorAll('.dock button').forEach(b => b.classList.remove('active')); const btn = document.getElementById('btn-'+page); if(btn) btn.classList.add('active'); }
    async function login() { localStorage.setItem('isLoggedIn', 'true'); location.reload(); }
    function logout() { localStorage.removeItem('isLoggedIn'); location.reload(); }

    // Starfield Animation
    const canvas = document.getElementById('star-canvas');
    if(canvas) {
        const ctx = canvas.getContext('2d'); let stars=[], warpSpeed=0;
        const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }; window.addEventListener('resize', resize); resize();
        class Star { constructor(){this.reset()} reset(){this.x=(Math.random()-0.5)*canvas.width*2; this.y=(Math.random()-0.5)*canvas.height*2; this.z=Math.random()*2000; this.pz=this.z} update(){this.z-=(10+warpSpeed); if(this.z<1){this.reset(); this.z=2000; this.pz=this.z}} draw(){const sx=(this.x/this.z)*500+canvas.width/2, sy=(this.y/this.z)*500+canvas.height/2, px=(this.x/this.pz)*500+canvas.width/2, py=(this.y/this.pz)*500+canvas.height/2; this.pz=this.z; const s=(2000-this.z)/2000; ctx.beginPath(); ctx.strokeStyle=`rgba(255,255,255,${s})`; ctx.lineWidth=s*3; ctx.moveTo(px,py); ctx.lineTo(sx,sy); ctx.stroke();} }
        for(let i=0;i<500;i++) stars.push(new Star());
        function animateStars(){ ctx.fillStyle="rgba(0,0,0,0.3)"; ctx.fillRect(0,0,canvas.width,canvas.height); stars.forEach(s=>{s.update();s.draw()}); requestAnimationFrame(animateStars); }
        animateStars();
    }
    function enterSystem() { warpSpeed = 100; document.querySelector('.welcome-content').style.opacity = '0'; setTimeout(() => { document.getElementById('welcome-screen').classList.add('hidden-screen'); setTimeout(() => { if(localStorage.getItem('isLoggedIn')==='true') { document.getElementById('app').classList.remove('hidden'); nav(localStorage.getItem('lastPage')||'dashboard'); initSystem(); initChat(); } else { document.getElementById('loginPage').classList.add('show'); } }, 800); }, 800); }
    function lockScreen() { document.getElementById('app').classList.add('hidden'); document.getElementById('loginPage').classList.remove('show'); const s=document.getElementById('welcome-screen'); s.classList.remove('hidden-screen'); warpSpeed=0; setTimeout(()=>{document.querySelector('.welcome-content').style.opacity='1';},100); }

    // Code & Settings Logic
    function updateLineNumbers() { const l=document.getElementById('codeEditor').value.split('\n').length; document.getElementById('lineNumbers').innerHTML=Array(l).fill(0).map((_,i)=>`<div id="line-${i+1}">${i+1}</div>`).join(''); }
    function syncScroll() { document.getElementById('lineNumbers').scrollTop = document.getElementById('codeEditor').scrollTop; }
    function changeLang() { const l=document.getElementById('langSelect').value; const e=document.getElementById('codeEditor'); if(l==='python'){e.value="print('Hello')\nfor i in range(5): print(i)"; switchTab('terminal');} else if(l==='web'){e.value="<h1>Hello</h1>"; switchTab('preview');} else {e.value=`// ${l}`; switchTab('terminal');} updateLineNumbers(); }
    function switchTab(t) { document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); if(t==='preview'){document.getElementById('previewFrame').style.display='block'; document.getElementById('terminalOutput').style.display='none'; document.getElementById('tabPreview').classList.add('active');} else {document.getElementById('previewFrame').style.display='none'; document.getElementById('terminalOutput').style.display='block'; document.getElementById('tabTerminal').classList.add('active');} }
    async function runCode() { const l=document.getElementById('langSelect').value; const c=document.getElementById('codeEditor').value; if(l==='web'){ switchTab('preview'); const d=document.getElementById('previewFrame').contentWindow.document; d.open(); d.write(c); d.close(); showToast("ƒê√£ ch·∫°y Web!"); } else { switchTab('terminal'); const t=document.getElementById('terminalOutput'); t.innerText="> Executing...\n"; try { const r=await fetch(`${API_URL}/execute`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lang:l,code:c})}); const d=await r.json(); t.innerText+=d.output; } catch(e){t.innerText+="Error: "+e;} } }
    async function aiAction(m) { const c=document.getElementById('codeEditor').value; const p=document.getElementById('codePrompt').value; const l=document.getElementById('langSelect').value; if(m==='suggest'&&!p) return showToast("Nh·∫≠p y√™u c·∫ßu!"); document.getElementById('aiLoading').style.display='flex'; try { const r=await fetch(`${API_URL}/code`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:m,code:c,prompt:p,lang:l})}); const d=await r.json(); if(m==='explain') alert(d.reply); else {document.getElementById('codeEditor').value=d.reply; updateLineNumbers();} } catch(e){showToast("L·ªói AI");} finally{document.getElementById('aiLoading').style.display='none';} }
    function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
    function toggleBg(chk) { document.querySelector('.fluid-bg').style.display = chk.checked ? 'block' : 'none'; }
    function changeFontSize(inp) { document.body.style.fontSize = inp.value + 'px'; }
    function changeBlur(inp) { document.documentElement.style.setProperty('--glass-blur', inp.value + 'px'); }
    function setAccent(btn, color) { document.documentElement.style.setProperty('--primary', color); document.documentElement.style.setProperty('--primary-glow', color+'80'); document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    function checkUpdate() { showToast("ƒêang ki·ªÉm tra..."); setTimeout(()=>showToast("ƒê√£ c·∫≠p nh·∫≠t m·ªõi nh·∫•t"), 1000); }
    function clearCache() { showToast("ƒê√£ x√≥a cache"); }

    // Utils
    async function fetchWeather() { try{const r=await fetch("https://api.open-meteo.com/v1/forecast?latitude=10.823&longitude=106.6296&current_weather=true"); const d=await r.json(); document.getElementById('weatherTemp').innerText=Math.round(d.current_weather.temperature)+"¬∞"; document.getElementById('weatherDesc').innerText="TP.HCM"; }catch(e){}}
    function updateNews() { const h=["Gemini 2.0 ra m·∫Øt","SupML OS c·∫≠p nh·∫≠t v15", "Javascript framework m·ªõi"]; const el=document.getElementById('newsTicker'); let i=0; setInterval(()=>{el.innerText=h[i]; i=(i+1)%h.length}, 3000); el.innerText=h[0]; }
    function initSystem() { fetchWeather(); updateNews(); setInterval(()=>{const n=new Date(); document.getElementById('clock').innerText=n.toLocaleTimeString(); document.getElementById('dashClock').innerText=n.toLocaleTimeString(); document.getElementById('date').innerText=n.toLocaleDateString(); document.getElementById('dashDate').innerText=n.toLocaleDateString();}, 1000); }
    function showToast(m) { const t=document.getElementById('toast'); t.innerHTML=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
</script>
</body>
</html>